---
title: "Cardiovascular Point-of-Care Ultrasonography and Resident Learning"
author:
- Anish Shah, MD^[Department of Medicine, School of Medicine, Emory University, Atlanta,
  Georgia]
- Mikhail Akbashev, MD^[Department of Medicine, School of Medicine, Emory University,
  Atlanta, Georgia]
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  word_document:
    highlight: tango
    reference_docx: word_style.docx
header-includes:
  - \usepackage{dcolumn}
  - \usepackage{float}
  - \usepackage{graphicx} 
editor_options: 
  chunk_output_type: console
always_allow_html: yes
csl: american-medical-association.csl
bibliography: medical_education.bib
---

```{r setup, global_options, include = FALSE}
knitr::opts_chunk$set(
  cache = TRUE,
  warning = FALSE,
  eval = TRUE,
  echo = FALSE,
  include = FALSE,
  message = FALSE,
  options(scipen = 999, digits = 3)
)

options(
  xtable.table.placement = "H",
  xtable.comment = FALSE
)
```

```{r}
# Libraries
source("1_libraries.R")

# Date intake
source("2_intake.R")

# Data tidying
source("3_tidy.R")
```

# Description

## Cohort summary 

The cohorts were divided by class years, from recent graduates of the program to current PGY3, PGY2, and PGY1. The data was acquired from 06/2018 to 08/2019. The population sampled was `r n_GRAD + n_PGY3 + n_PGY2 + n_PGY1` residents (including recent grads).

The response rates per group is shown. The surveys were sent from June 2018 to August 2018. 

| Cohort | n | Response (%) |
| --- | --- | --- |
| GRAD | `r n_GRAD` | `r length(demo$id[demo$cohort=="GRAD"])/n_GRAD * 100 ` |
| PGY3 | `r n_PGY3` | `r length(demo$id[demo$cohort=="PGY3"])/n_PGY3 * 100 ` |
| PGY2 | `r n_PGY2` | `r length(demo$id[demo$cohort=="PGY2"])/n_PGY2 * 100 ` |
| PGY1 | `r n_PGY1` | `r length(demo$id[demo$cohort=="PGY1"])/n_PGY1 * 100 ` |

From the responses, the comfort in diagnosis, procedural career interest (i.e. cardiology, pulmonary), and participation in the ultrasound curriculum was reviewed.

```{r, results='asis'}
tabular((cohort + 1) ~ (n = 1) + comfort_dx + proc_career + curriculum, data = demo) %>%
  as.matrix() %>%
  xtable(., caption = "Cardiac Views") %>%
  print(., include.rownames = FALSE, include.colnames = FALSE, caption.placement = "top")
```

## Description of quiz responses by cohort

The quiz was broken down into several sections. There were 5 targeted areas for the survey.

- Cardiovascular view identification
- Cardiovascular structure identification
- Cardiovascular function assessment (e.g. ejection fraction)
- Vascular structure identification (e.g. IVC, aorta)
- Vascular function assessment (e.g. collapsibility of IVC)

The responses are in the form of a percent by each cohort, so within cohort comparisons can be assessed.

```{r, results='asis'}

# Combine quiz and demographic data
df <- full_join(demo, quiz, by = "id")

# Summarize the quiz data, if possible
# Cardiovascular view first
tabular((cv1 + cv2 + cv3 + cv4 + cv5 + cv6) * (Percent("col")) * Format(digits = 2) ~ (cohort + 1), data = df) %>%
  as.matrix() %>%
  xtable(., caption = "Cardiac Views") %>%
  print(., include.rownames = FALSE, include.colnames = FALSE, caption.placement = "top")

# Cardiac structures
tabular((cs1 + cs2 + cs3) * (Percent("col")) * Format(digits = 2) ~ (cohort + 1), data = df) %>%
  as.matrix() %>%
  xtable(., caption = "Cardiac Structures") %>%
  print(., include.rownames = FALSE, include.colnames = FALSE, caption.placement = "top")

# Cardiac function
tabular((cf1 + cf2 + cf3 + cf4 + cf5) * (Percent("col")) * Format(digits = 2) ~ (cohort + 1), data = df) %>%
  as.matrix() %>%
  xtable(., caption = "Cardiac Function") %>%
  print(., include.rownames = FALSE, include.colnames = FALSE, caption.placement = "top")

# Vascular structures
tabular((vs1 + vs2) * (Percent("col")) * Format(digits = 2) ~ (cohort + 1), data = df) %>%
  as.matrix() %>%
  xtable(., caption = "Vascular Structures") %>%
  print(., include.rownames = FALSE, include.colnames = FALSE, caption.placement = "top")

# Vascular structures
tabular((vf1 + vf2 + vf3 + vf4) * (Percent("col")) * Format(digits = 2) ~ (cohort + 1), data = df) %>%
  as.matrix() %>%
  xtable(., caption = "Vascular Function") %>%
  print(., include.rownames = FALSE, include.colnames = FALSE, caption.placement = "top")
```

## Quiz Accuracy

The quiz was graded against an expert review by attendings in critical care and emergency medicine with ultrasound training.

```{r, results='asis'}
# Combine scores and demographic information
df <- full_join(demo[c("id", "cohort", "curriculum", "proc_career")], df_scores, by = "id") %>% na.omit()

# Table of scores
tabular((cohort + 1) ~ (percent) * Format(digits = 2) * (mean + sd), data = df) %>%
  as.matrix() %>%
  xtable(., caption = "Mean scores for cohort") %>%
  print(., include.rownames = FALSE, include.colnames = FALSE, caption.placement = "top")
```

The active intervention was the completion of the ultrasound curriculum. With Welch's two sample t-test:

```{r, results='asis'}
t.test(
  df$percent[df$curriculum == "Yes"],
  df$percent[df$curriculum == "No"]
)
```

This suggests that the scores were significantly different by the advent of hte curriculum. However, years in training may mediate the effect. 

```{r, out.width="60%"}
# Using prior dataframe
ggplot(df, aes(x = cohort, y = percent, fill = cohort)) +
  geom_boxplot() +
  labs(
    title = "Training cohorts and quiz accuracy",
    x = "Level of training",
    y = "Percent correct"
  ) +
  theme_minimal() +
  scale_fill_viridis_d()
```

# Overconfidence

Residents also labeled their confidence in their answer choices. Four categories were devised representing POCUS knowledge and confidence in decision-making.

- Understanding: correct, confident
- Underconfident: correct, not confident
- Knowledge Gap: incorrect, not confident
- Overconfident - incorrect, confident

# Distribution of confidence

```{r, results='asis'}
# Data needed is overconfidence and demographic
df <- na.omit(inner_join(demo, df_overconfidence, by = "id"))

# Confidence level visualization by cohort
ggplot(df, aes(x = question, fill = level)) +
  facet_wrap(~cohort) +
  geom_bar(position = "fill") +
  labs(
    title = "Distribution of Confidence",
    x = "Question identifiers",
    y = "Response count distribution",
    caption = "Each question subgroup (e.g. CS, CF, CV, VF, VS) are in increasing difficulty"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_viridis_d()

# Confidence level by curriculum 
ggplot(df, aes(x = question, fill = level)) +
  facet_wrap(~curriculum) +
  geom_bar(position = "fill") +
  labs(
    title = "Distribution of Confidence",
    x = "Question identifiers",
    y = "Response count distribution",
    caption = "Each question subgroup (e.g. CS, CF, CV, VF, VS) are in increasing difficulty"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_viridis_d()
```

This graph shows a pattern of an increasing amount of confidence with the further levels of training, at least visually, as well as by addition of curriculum.

```{r, results='asis', out.width="60%"}
# Similar data frame as above
ggplot(df, aes(x = level, fill = cohort)) +
  facet_wrap(~cohort, ncol = 1) +
  geom_bar(aes(y = ..prop.., group = 1), position = "dodge") +
  scale_fill_viridis_d() +
  theme_minimal() +
  coord_flip() +
  labs(
	   title = "Overconfidence by cohort year",
	   x = "Categories",
	   y = "Percent"
	   )
```

This visualization represents the increase in overall confidence and correct answers with time/curriculum, however these two terms interact and confound interpretation. 

## Confidence and accuracy combined

```{r, results='asis'}
# Data
df <- gather(df_concordance[c("id", "question", "correctness", "confidence")], key = "measure", value = "value", -id, -question) %>%
  inner_join(demo, ., by = "id") %>%
  na.omit()

# Visualize confidence and accuracy by curriculum
ggplot(df, aes(x = question, fill = measure)) +
  facet_wrap(~curriculum) +
  geom_bar(aes(y = value), position="dodge", stat = "summary", fun.y = "mean") +
  scale_fill_viridis_d(begin = .2) + 
  theme_minimal() +
  labs(
    title = "Confidence and accuracy by curriculum introduction",
    x = "Questions",
    y = "Mean"
  ) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

## Regression analysis of confidence

Simple regression analysis will start to establish the most important relationships, although a more complex model may be needed (e.g. mixed effects, structured equation modelling, etc)

```{r, results='asis'}
# Data
df <-
  inner_join(demo[c("id", "cohort", "curriculum", "interest_level", "comfort_dx", "proc_career")], df_concordance, by = "id") %>%
  mutate_at(c("id", "question"), funs(factor(.))) %>%
  na.omit()

# Description of data
tabular((curriculum + cohort + 1) ~ (correctness + confidence + agreement)*(mean + sd)*Format(digits = 2), data = df) %>%
  as.matrix() %>%
  xtable(., caption = "Description of concordance") %>%
  print(., include.rownames = FALSE, include.colnames = FALSE, caption.placement = "top")
```

```{r}
# Initial regressions ...
a <- clmm(factor(agreement) ~ curriculum + (1 | id), data = df, Hess = 1)
b <- clmm(factor(agreement) ~ curriculum + proc_career + interest_level + (1 | id), data = df)
c <- clmm(factor(agreement) ~ cohort + (1 | cohort / id), data = df)
d <- clmm(factor(agreement) ~ curriculum + cohort + (1 | cohort / id), data = df)
e <- clmm(factor(agreement) ~ curriculum + cohort + curriculum:cohort + (1 | cohort / id), data = df)
f <- clmm(factor(agreement) ~ curriculum + cohort +  (1|cohort/id) + (1|cohort/curriculum), data = df, Hess = 1)

# Focusing on curriculum effect

summary(a)
summary(b)
summary(c)
```

Through regression analysis, it seems that the curriculum is significant in improving level of confidence-knowledge agreement. However, training level is a strong predictor as well, however the interaction between cohort and curriculum cannot be pulled apart through simple testing. 

The OR of being overconfident = `r exp(a$coefficients[1])`, which means that the addition of the curriculum decreases the odds of being overconfident by 4-fold.  We may extend that there is a ordinal linearity between overconfidence, knowledge gaps, and appropriate confidence/correctness.


# Results

## Baseline characteristics

```{r baseline characterisics}
# Data set
df <- demo

# Compare groups
cmp <- compareGroups(cohort ~ curriculum + experience + comfort_dx + comfort_tx + interest_level + proc_career, data = df)
cmp_tbl <- createTable(cmp, show.n = F, show.ratio = F, show.p.overall = F)
```

- description of baseline cohort
- describe the interest/comfort in sonography, as well as career
- describe cohort/curriculum presence

## Point-of-care ultrasonography knowledge 

```{r score by class}
# Data
df <- inner_join(demo, df_scores) %>% 
  compareGroups(cohort ~ percent, data = .) %>%
  createTable(., show.n = F, show.ratio = F, show.p.overall = F)
```

The mean percent score (SD) on the questionnaire was `r mean(na.omit(df_scores$percent))`% (`r sd(na.omit(df_scores$percent))`). By cohort, the PGY1 class scored `r df$descr[1,1]`, the PGY2 class scored `r df$descr[1,2]`, the PGY3 class scored `r df$descr[1,3]`, and the recent graduates scored `r df$descr[1,4]`. The questions were further broken down by type, as seen in __Figure XXX___.

- quiz description 
- quiz accuracy

## Confidence and overconfidence


# Tables

## Table 1

```{r}
export2csv(cmp_tbl, file = "table1.csv")
```

# Figures

## Figure 1

```{r plot score by type of question}
# data
df <-
  gather(df_scores[-c(22,23)], key = "question", value = "score", -id) %>%
  inner_join(., quiz_guide, by = "question") %>%
  inner_join(demo[c("id", "cohort")], ., by = "id")

# Relabel the question types
df$question_type %<>% factor()
levels(df$question_type) <- c("LVEF", "CV Anatomy", "US View", "Volume", "Vasc Strx")
  
# Score by group
ggplot(data = na.omit(df), aes(x = cohort, y = score, fill = cohort)) + 
  stat_summary(fun.y = "mean", geom = "bar") +
  scale_y_continuous(labels = scales::percent) + 
  facet_wrap(~question_type) + 
  scale_fill_viridis_d() + 
  theme(
    legend.position = "none"
  ) + 
  theme_minimal() 
```


## Figure 2

